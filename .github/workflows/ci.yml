name: ci

on:
  push:
    branches: [ main ]
  pull_request:
  workflow_dispatch:
    inputs:
      preflight_base_url:
        description: "Target deployment base URL (e.g. https://your-platform.up.railway.app)"
        required: true
        type: string

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown
      - uses: Swatinem/rust-cache@v2
      - name: Install cargo-leptos
        run: cargo install cargo-leptos --locked
      - name: Build SSR
        run: cargo build -p platform --features ssr
      - name: Build Hydrate (Wasm)
        run: cargo build -p platform --no-default-features --features hydrate --target wasm32-unknown-unknown
      - name: Clippy
        run: cargo clippy --workspace --all-targets -- -D warnings

  e2e-social-flow:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - name: Start infra services
        run: docker compose up -d postgres redis nats clickhouse
      - name: Run platform server (background)
        run: |
          DATABASE_URL='postgres://postgres:postgres@127.0.0.1:5432/platform' \
          REDIS_URL='redis://127.0.0.1:6380' \
          NATS_URL='nats://127.0.0.1:4222' \
          CLICKHOUSE_URL='http://127.0.0.1:8123' \
          JWT_SECRET='dev-secret' \
          cargo run -p platform --features ssr --bin platform-server > server.log 2>&1 &
      - name: Run social e2e script
        shell: pwsh
        run: ./scripts/e2e-social-flow.ps1
      - name: Smoke check endpoints
        shell: bash
        run: |
          set -euo pipefail
          curl -fsS http://127.0.0.1:3000/health | tee /tmp/health.json
          curl -fsS http://127.0.0.1:3000/ready | tee /tmp/ready.json
          curl -fsS http://127.0.0.1:3000/ | head -c 200 > /tmp/root_snippet.txt
          test -s /tmp/root_snippet.txt
      - name: Print server logs on failure
        if: failure()
        run: |
          echo '===== server.log ====='
          cat server.log || true
          echo '===== docker compose ps ====='
          docker compose ps
          echo '===== nats logs ====='
          docker compose logs nats || true
          echo '===== postgres logs ====='
          docker compose logs postgres || true
      - name: Stop infra services
        if: always()
        run: docker compose down -v

  preflight-remote:
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Run deploy preflight against remote base URL
        shell: pwsh
        run: |
          $baseUrl = "${{ inputs.preflight_base_url }}"
          if ([string]::IsNullOrWhiteSpace($baseUrl)) {
            throw "preflight_base_url is required"
          }

          ./scripts/deploy-preflight.ps1 `
            -BaseUrl $baseUrl `
            -SkipEnvCheck `
            -SkipTcpCheck
